<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MetPetDB Image Map</title>
	<!-- Style Sheets ------------------------------------------------------------------ -->
	<link rel="stylesheet" href="css/bootstrap.css" type="text/css"/>
	<link rel="stylesheet" href="css/style.css" type="text/css"/>
	    <link rel="stylesheet" href="lib/font-awesome/css/font-awesome.min.css">

	<!--
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />

    <link rel="stylesheet" href="lib/theme/default/style.css" type="text/css">
    <link rel="stylesheet" href="lib/styles.css" type="text/css">
	-->
	<!-- Core Scripts ----------------------------------------------------------------------------->
    <script src="lib/jquery.js" type="text/javascript"></script>
    <script src="lib/jquery.csv.js" type="text/javascript"></script>
    <script src="lib/jquery.tooltip.js" type="text/javascript"></script>
    <script src="lib/downloadify.min.js" type="text/javascript"></script>
    <script src="lib/swfobject.js" type="text/javascript"></script>
	<script src="lib/jquery-ui.js"></script>
    <script src="lib/lightbox/js/jquery.lightbox_me.js" type="text/javascript"></script>

	<script src="lib/FileAPI/FileAPI.min.js"></script>
    <script src="lib/OpenLayers.js"></script>    
    <script src="lib/OpenLayers/Control/ScaleBar.js"></script>    
    <script type="text/javascript" language="javascript" src="lib/media/js/jquery.dataTables.js"></script>
    <script src="lib/jszip/jszip.js"></script>
    <script src="lib/jszip/jszip-load.js"></script>
    <script src="lib/downloadify/src/downloadify.js"></script>
    <script src="lib/Blob.js"></script>
<!--
    <script src="lib/Ragbag/Control/ModifyFeature-tools.js"></script>
    <script src="lib/Ragbag/Handler/Path-patch.js"></script>
-->
    <script src="lib/FileSaver.js"></script>
    <script src="lib/mpdb/Extend.js"></script>
    <script src="lib/mpdb/ImageMap.js"></script>
<link href="css/simple-slider-volume.css" rel="stylesheet" type="text/css">
<link href="css/simple-slider.css" rel="stylesheet" type="text/css">
<script src="lib/simple-slider.min.js"></script>
    <script src="lib/OpenLayers/Layer/PointGrid.js"></script>
    <script src="lib/OpenLayers/Control/KeyboardNudge.js"></script>
    <script src="lib/mpdb/Helpers.js"></script>

    <script type="text/javascript">
    var m_url = "";
	var map = null;
	var div = "map";


    	function create_map(form){
		       document.getElementById("new_map").style['display'] = "none";
		       var url_, name_, scale_;
		       var url = "";
    	if (form == null || (form.parentNode.baseurl.value == "" && form.parentNode.baseimage.files.length == 0)){
    		map = new ImageMap(div, "Base Layer", null, window.innerWidth * 0.78, {height: window.innerHeight * .85})
    		console.log(map)
		    document.getElementById(div).style['display'] = "";

    		/*
	    	scale_ = QueryString.scale;
	       	 url_ = "img/" + QueryString.baseimage.split("\\").slice(-1)[0];

	       	if (url_ == "img/" ) { url_ = "img/" + QueryString.baseimage.split("/").slice(-1)[0]; }
	       	if (url_ == "img/" ) { url_ = "img/" + QueryString.baseimage.value; }
	       	name_ = (QueryString.name != "") ? QueryString.name : QueryString.baseimage.replace(".jpg", " ");
	       	*/	       

    	}
    	else {

	    	form = form.parentNode;
		   	name_ = (form.name.value != "") ? form.name.value : 	form.baseimage.value.replace(".jpg", " ");	       
	        scale_ = form.scale.value;
	        if (!name_ || name_ == "") name_ = "Base Layer"




/*	
    		var f = ImageMap.MakeFeature("asdf", "img/rock_1.jpg", ImageMap.MakeBoundsFromPoint(0,0,100,100));
    		var l = map.makeLayer("lay");
    		map.addFeatureToLayer(f, l);
    		map.addLayer(l);
*/
			//map.map.zoomToExtent( ImageMap.MakeBoundsFromWH( baseImageWidth_, baseImageHeight_  ));

		    // end onload
		    
		    
		    
		    
		    document.getElementById("new_map").style['display'] = "none";
	    	if (form.baseurl.value && form.baseurl.value != ""){
		    	url = form.baseurl.value;
		    document.getElementById(div).style['display'] = "";
		    	map = new ImageMap(div, name_, url, scale_);

	    	}
	    	else if (form.baseimage.files.length == 0){
		    	map = new ImageMap(div, name_ || "Base Layer", null, scale_ || 100);
	    	}
	    	else {
		    	var reader = new FileReader();
		    	reader.onload = function(e) { 
			    url = e.target.result; 

		    	map = new ImageMap(div, name_, url, scale_);
			    document.getElementById(div).style['display'] = "";	
			    }
			    reader.readAsDataURL(form.baseimage.files[0]);

			} 
	}	
	
	}
	       	

    	
        function init(){
	       
	       var mode = QueryString.mode;
	       if (QueryString.name){
		       create_map(null);
		       alert("map")

	       }
	       else {
		       document.getElementById("new_map").style['display'] = "none";
		       document.getElementById("map").style['display'] = "";
		       map = new ImageMap(div, "Base Layer", null, window.innerWidth * .78, {height: window.innerHeight * .85})
	       }

      }
      
    </script>
  </head>
  <body onload="init()">
	<div class="">
	
		<iframe name="dl" style="display:none;"></iframe>

		<div id="new_map" style="display:none;">
		<h1 id="version">IMAGE MAP v1.00</h1>
		<hr>
		<h3 id="map_name">NEW MAP</h3>
		<div id="formblock" class="span8">
			<form name="newmapf" class="form-inline" onsubmit="">
				<input type="text" name="name" placeholder="Image Name" />
				<input type="file" id="baseimage" name="baseimage" multiple  /><br />
				<input type="url" placeholder="Optionally enter the URL of the Base Image" size=55 value="" name='baseurl' /><br />
				<input type="text"  size="30" value="100"  placeholder="Optional Scale in mm" name="scale" /><br />
				<input type="submit" id="submit_btn" class="btn-diff" onclick="javascript:create_map(this);  return false;" />
			</form>
		</div>
			<output id="list"></output>

		</div>
		<div style="width:100%">
			<div id="map_nav"></div>
			<div id="t_head" style="display:block !important;">		    
				<h1 >MetPetDB IMAGE MAP</h1>
				<hr>
			</div>

		</div>
		
		
		<div id="map" style=";">
			<div id="t_head" style="display:block !important;">		    
				<h1 >MetPetDB IMAGE MAP</h1>
				<hr>
			</div>
			<div onclick="popup_func(null,ImageMap.map.map.center);document.getElementById('mapmap').className = 'olMap'; this.parentNode.removeChild(this)" id='draghere' ondragover="document.getElementById('mapmap').className = 'olMap'; this.parentNode.removeChild(this); " >
			
				<h4><a href="javascript:popup_func(null,ImageMap.map.map.center);document.getElementById('mapmap').className = 'olMap'; this.parentNode.removeChild(this)" id='draghere' ondragover="document.getElementById('mapmap').className = 'olMap'; this.parentNode.removeChild(this); ">Drag Images Here</a></h4>	
			</div>
		</div>
		
		
		<form name='saveF'>
			<div id='ips' style="margin:0 auto; display:none;margin-top:90px;" >
			   <table name='pointTable' id='pointTable'>
						<thead>

					</thead>
					
					<tbody id="points" class="pointss connectedSortable">
						
					</tbody>
					
					
<!--
-->

				</table>
				<center>
				<br />
				<table name='queueTable' id='queueTable'>
					<thead>
						<tr><th colspan="4">Map Queue</th></tr>
					</thead>
					
					 <tbody id="queue" style="" class="pointss connectedSortable">

					</tbody>

				
				</table>
												</center>

				<br />
				
				<div style="width:100%; text-align:center;">
				<div style="margin:0 auto; text-align:center;">
				<div style="width:50%; margin:0 auto;">
								<b>Point Shape:</b> <br />
				Diamond<input type='radio' checked="checked" name="pshape" value="diamond" /><br />
				Circle<input type='radio' name="pshape" value="circle" /><br />
				Square<input type='radio' name="pshape" value="square" /><br /><br/>
				
				</div>
				
				<div style="width:50%; margin:0 auto;text-align:left">
				
				<b>Point Size</b><br />
				
<input type="text" data-slider="true" id='point_size' data-slider-range="1,10" data-slider-step='1'  style="display: none; width:100px !important;">				<script>

  $("[data-slider]")
    .each(function () {
      var input = $(this);
      $("<span>")
        .addClass("output")
        .insertAfter($(this));
    })
    .bind("slider:ready slider:changed", function (event, data) {
      $(this)
        .nextAll(".output:first")
          .html(data.value.toFixed(3));
    });
  
				</script>	
				
				

				</div>

				<div style="clear:both;"></div>
				</div></div>
							<!-- Save image paths only --><input type="checkbox" style="display:none;" value="inline" id='save_inline' name="inline" />


			
			<iframe id="upload_target" name="upload_target" src="" style="display:none; width:500px;height:200px;border:1px solid #ccc;"></iframe>
		</form>



		<div id="aToolTip" class="defaultTheme">  
			<p class="aToolTipContent">Your tooltip content</p>  
		</div>  


		</div>
			<form name="userpic" class="upload">
			<div id="preview" class="upload__preview"></div>

			<div class="upload__link">
				<a class="upload-link js-fileapi-wrapper">
					<input  style='display:none;' id="upload-link__inp" class="upload-link__inp" name="photo" type="file"  />
				</a>
				
			</div>
		</form>
		<center>
		<div id="bottom_bar" style="margin:0 auto;" class="">
			<form name="csv" >
			
		<input type="button" value="Load Map From File" class="btn-diff" onclick="javascript:document.forms.userpic.photo.click()" />
		<input type="button" value="Load Data From CSV" class="btn-diff" onclick="javascript:this.form.csvFile.click(); document.getElementById('ips').style['display'] = ''" />
		<input type="file" value="Add Data" class="btn-diff" style="display:none;" id="csvFile" name="csvFile" />
		<input type="button" value="Download All Data" class="btn-diff" style=";" name="dad" onclick="ImageMap.map.downloadAllData();" />


			</form>
		</div>
		</center>
	</div>


	<script>
				var form = document.forms.userpic;
				var mf = document.forms.newmapf;
				// Ссылка на инпут, через который юзер будет выбирать файл
				var input = form.photo;
				var datainput = document.forms.csv.csvFile;
				var bi = mf.baseimage;

				var text = ""
		var _onSelectFile = function (evt){

			var file = FileAPI.getFiles(evt)[0];
			var f = (function(aImg) { return function(e) { text = e.target.result; }; })(text);

	//		FileAPI.readAsText(file,f);
	    var reader = new FileReader();
	    reader.onload = function(event) {
	        text = event.target.result;
			if (!map){

				   document.getElementById("new_map").style['display'] = "none";
				   document.getElementById(div).style['display'] = "";
				   map = ImageMap.load("map", text);
				   map.layerSwitcher.redraw(1);
								

			}
			else {

					delete map;
					document.getElementById("map").innerHTML = "";
					if (document.getElementById("layerswitcher")){
						document.getElementById("layerswitcher").innerHTML = "";
						document.getElementById("scaleline-id").innerHTML = "";
					}

		map = null;
		map =	ImageMap.load('map',text);


			}

					
	    };
	 
	    /* The readAsText method will read the file's data as a text string. By default the string is decoded as 'UTF-8'. */
	    reader.readAsBinaryString(file);

		};


	var _onSelectFileCSV = function(evt){
		var reader = new FileReader();
		reader.onload = function(e) { 
			data = e.target.result; 
			console.log(data);
			data = data.replace(/\r/g, '\n');
			data = data.replace(/\r\n/g, '\n');

			ImageMap.Data.readCSV(data);
			$('table tbody tr').click(function() {   console.log("Things");      $(this).toggleClass("selected"); })

		}
		reader.readAsText(FileAPI.getFiles(evt)[0]);

	}

	var input = document.getElementById('upload-link__inp');

	FileAPI.event.on(input, "change", _onSelectFile);
	FileAPI.event.on(datainput, "change", _onSelectFileCSV);

	function deleteAndLoad(){
							delete map;
					document.getElementById("map").innerHTML = "";
					if (document.getElementById("layerswitcher")){
						document.getElementById("layerswitcher").innerHTML = "";
						document.getElementById("scaleline-id").innerHTML = "";
					}

		map = null;
//var elmtTable = document.getElementById('p');
//var tableRows = elmtTable.getElementsByTagName('tr');
//var rowCount = tableRows.length;

//for (var x=rowCount-1; x>0; x--) {
	//console.log(tableRows[x]);
	//if (tableRows[x] != "" && tableRows[x] != "\n")
	//	elmtTable.removeChild(tableRows[x]);
//}


	    	var db = openDatabase('Map', '1.0', 'Map', 100 * 1024 * 1024);
console.log(db);
db.transaction(function (tx) {
   tx.executeSql('SELECT * FROM save ORDER BY id DESC', [], function (tx, results) {
   	 map = ImageMap.load('map', results.rows.item(0).json);
 }, function(tx){console.log(tx); console.log("SDF")},function(tx){console.log(tx); console.log("SfDF")});
});
		

	//	map =	ImageMap.load('map',localStorage['imap']);


	}

	</script>

  <script>

			  $('table tbody tr').click(function() {   console.log("Things");      $(this).toggleClass("selected"); })



  </script>


  </body>
</html>